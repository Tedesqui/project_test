<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>𝐀𝐑𝐑𝐄𝐒𝐓 - Reconhecimento</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        /* (Manter os estilos anteriores) */
    </style>
</head>
<body>

    <div id="webcam-container">
        <div class="zoom-indicator" id="zoomIndicator">1.0x</div>
        <div id="camera-error" style="display:none; color:white; text-align:center; padding:20px;">
            Não foi possível acessar a câmera traseira.<br>
            <button onclick="retryCameraAccess()" style="margin-top:10px;">Tentar Novamente</button>
        </div>
    </div>
    <!-- (Manter o resto do HTML anterior) -->

    <script type="text/javascript">
        // (Manter as variáveis anteriores)

        async function init() {
            startButton.disabled = true;
            startButton.innerText = "Carregando...";

            // Esconde mensagem de erro se estiver visível
            document.getElementById('camera-error').style.display = 'none';

            if (webcam) {
                await webcam.stop();
                const oldCanvas = document.querySelector('#webcam-container canvas');
                if (oldCanvas) oldCanvas.remove();
                clearAlert();
            }

            if (!model) {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                try {
                    model = await tmImage.load(modelURL, metadataURL);
                    maxPredictions = model.getTotalClasses();
                } catch (e) {
                    console.error("Erro ao carregar o modelo:", e);
                    startButton.innerText = "Erro no Modelo";
                    showCameraError("Erro ao carregar o modelo de IA");
                    return;
                }
            }
            
            try {
                // Tentativa mais robusta de acessar a câmera traseira
                const constraints = {
                    video: {
                        facingMode: { exact: "environment" },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                // Primeiro tenta com as constraints ideais
                await setupWebcam(constraints);
                
            } catch (firstError) {
                console.log("Primeira tentativa falhou, tentando fallback:", firstError);
                
                try {
                    // Fallback 1: Tentativa sem especificar resolução
                    const fallbackConstraints1 = {
                        video: {
                            facingMode: { exact: "environment" }
                        }
                    };
                    await setupWebcam(fallbackConstraints1);
                    
                } catch (secondError) {
                    console.log("Fallback 1 falhou, tentando fallback 2:", secondError);
                    
                    try {
                        // Fallback 2: Tentativa com qualquer câmera
                        const fallbackConstraints2 = {
                            video: true
                        };
                        await setupWebcam(fallbackConstraints2);
                        
                    } catch (finalError) {
                        console.error("Todas as tentativas falharam:", finalError);
                        startButton.innerText = "Ligar Câmera";
                        startButton.disabled = false;
                        showCameraError("Não foi possível acessar nenhuma câmera. Verifique as permissões.");
                        return;
                    }
                }
            }
            
            startButton.innerText = "Reiniciar Câmera";
            startButton.disabled = false;
        }

        async function setupWebcam(constraints) {
            const flip = false;
            const isPortrait = window.innerHeight > window.innerWidth;
            const width = isPortrait ? window.innerWidth : Math.floor(window.innerHeight * 0.75);
            const height = isPortrait ? Math.floor(window.innerHeight * 0.7) : window.innerHeight;
            
            webcam = new tmImage.Webcam(width, height, flip);
            
            // Configuração especial para iOS
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                constraints.video.facingMode = "environment"; // iOS pode não suportar 'exact'
            }
            
            await webcam.setup(constraints);
            await webcam.play();
            
            videoTrack = webcam.stream.getVideoTracks()[0];
            await setupZoomControls();
            
            const webcamContainer = document.getElementById("webcam-container");
            webcamContainer.innerHTML = '';
            webcamContainer.appendChild(webcam.canvas);
            zoomIndicator.style.display = 'block';
        }

        function showCameraError(message) {
            const errorDiv = document.getElementById('camera-error');
            errorDiv.innerHTML = message + '<br><button onclick="retryCameraAccess()" style="margin-top:10px;">Tentar Novamente</button>';
            errorDiv.style.display = 'block';
        }

        function retryCameraAccess() {
            init();
        }

        // (Manter as outras funções anteriores)
    </script>
</body>
</html>
